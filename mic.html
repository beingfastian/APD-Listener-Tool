<!DOCTYPE html>
<html>
<head>
  <title>Instruction Workspace</title>
  <style>
    body { font-family: Arial, sans-serif; }

    button {
      margin: 4px;
      padding: 6px 10px;
      cursor: pointer;
    }

    #controls button.active {
      background: #444;
      color: white;
    }

    .instruction {
      margin-top: 16px;
      padding: 10px;
      border: 1px solid #ddd;
    }

    .instruction-title {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .step {
      display: flex;
      align-items: center;
      margin-left: 20px;
      margin-bottom: 4px;
    }

    .step span {
      margin-left: 8px;
      margin-right: 12px;
    }

    .icon-btn {
      font-size: 16px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .icon-btn:hover {
      color: green;
    }

    #slider { width: 500px; }
  </style>
</head>
<body>

<h2>Instruction Workspace</h2>

<button onclick="startRecording()">üéô Start Recording</button>
<button onclick="stopRecording()">‚èπ Stop Recording</button>

<br><br>

<input type="file" accept="audio/*" onchange="uploadFile(this.files[0])">

<hr>

<!-- GLOBAL PLAYER -->
<div id="controls">
  <button id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
  <button onclick="prev()">‚èÆ</button>
  <button onclick="next()">‚è≠</button>
  <button id="repeatBtn" onclick="toggleRepeat()">üîÅ</button>
  <button id="loopBtn" onclick="toggleLoop()">üîÇ</button>
</div>

<input id="slider" type="range" min="0" step="0.01">

<hr>

<h3>Instructions & Steps</h3>
<div id="instructionContainer"></div>

<pre id="output"></pre>

<script>
/* ================= AUDIO OBJECTS ================= */
const mainAudio = new Audio()
const stepAudio = new Audio()

/* ================= STATE ================= */
let timeline = []
let instructions = []
let index = 0
let isPlaying = false
let repeatOne = false
let loopAll = false

/* ================= ELEMENTS ================= */
const slider = document.getElementById("slider")
const playBtn = document.getElementById("playBtn")
const repeatBtn = document.getElementById("repeatBtn")
const loopBtn = document.getElementById("loopBtn")
const instructionContainer = document.getElementById("instructionContainer")
const output = document.getElementById("output")

/* ================= RECORD / UPLOAD ================= */
let recorder, chunks=[]

async function startRecording() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
  recorder = new MediaRecorder(stream)
  chunks=[]
  recorder.ondataavailable=e=>chunks.push(e.data)
  recorder.onstop=()=>{
    const file=new File([new Blob(chunks)],"recording.wav",{type:"audio/wav"})
    sendAudioFile(file)
  }
  recorder.start()
}

function stopRecording(){
  if(recorder && recorder.state!=="inactive") recorder.stop()
}

function uploadFile(file){
  if(file) sendAudioFile(file)
}

/* ================= SEND ================= */
async function sendAudioFile(file){
  const fd=new FormData()
  fd.append("file",file)

  output.textContent="Processing..."

  const res=await fetch("/analyze-audio",{method:"POST",body:fd})
  const data=await res.json()

  output.textContent=JSON.stringify(data,null,2)

  instructions=data.instructions || []
  renderInstructions()
}

/* ================= RENDER ================= */
function renderInstructions(){
  instructionContainer.innerHTML=""

  instructions.forEach((instr, i)=>{
    const box=document.createElement("div")
    box.className="instruction"

    const title=document.createElement("div")
    title.className="instruction-title"
    title.textContent=instr.instruction
    box.appendChild(title)

    instr.steps.forEach(step=>{
      const row=document.createElement("div")
      row.className="step"

      const speak=document.createElement("button")
      speak.className="icon-btn"
      speak.textContent="üîä"
      speak.onclick=()=>playStep(step.audio)

      const text=document.createElement("span")
      text.textContent=step.text

      const download=document.createElement("a")
      download.href=step.download
      download.download=""
      download.textContent="‚¨áÔ∏è"
      download.className="icon-btn"

      row.appendChild(speak)
      row.appendChild(text)
      row.appendChild(download)

      box.appendChild(row)
    })

    instructionContainer.appendChild(box)
  })
}

/* ================= STEP AUDIO ================= */
function playStep(src){
  stepAudio.pause()
  stepAudio.src=src
  stepAudio.currentTime=0
  stepAudio.play()
}

/* ================= GLOBAL PLAYER (OPTIONAL) ================= */
/* Kept minimal; your previous logic can be reattached if needed */

function togglePlay(){
  if(isPlaying){
    mainAudio.pause()
    isPlaying=false
  } else {
    mainAudio.play()
    isPlaying=true
  }
  updateButtons()
}

function prev(){}
function next(){}

function toggleRepeat(){
  repeatOne=!repeatOne
  updateButtons()
}

function toggleLoop(){
  loopAll=!loopAll
  updateButtons()
}

function updateButtons(){
  playBtn.classList.toggle("active",isPlaying)
  repeatBtn.classList.toggle("active",repeatOne)
  loopBtn.classList.toggle("active",loopAll)
}
</script>

</body>
</html>
