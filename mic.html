<!DOCTYPE html>
<html>
<head>
    <title>Record Instruction</title>
</head>
<body>

<h1>Record Instruction</h1>

<button onclick="startRecording()">ğŸ™ Start Recording</button>
<button onclick="stopRecording()">â¹ Stop Recording</button>
<button onclick="resetAll()">ğŸ”„ Reset</button>

<br><br>

<input type="file" accept="audio/*" onchange="uploadFile(this.files[0])">

<br><br>

<button onclick="speakSteps()">ğŸ”Š Speak Steps</button>

<pre id="output"></pre>

<script>
let recorder;
let chunks = [];
let lastSteps = [];

async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/wav" });
        sendRecordedAudio(blob);
    };

    recorder.start();
}

function stopRecording() {
    if (recorder && recorder.state !== "inactive") {
        recorder.stop();
    }
}

function resetAll() {
    document.getElementById("output").textContent = "";
    lastSteps = [];
}

async function uploadFile(file) {
    sendAudioFile(file);
}

async function sendRecordedAudio(blob) {
    const file = new File([blob], "recording.wav", { type: "audio/wav" });
    sendAudioFile(file);
}

async function sendAudioFile(file) {
    const form = new FormData();
    form.append("file", file);

    document.getElementById("output").textContent = "Processing...";

    const res = await fetch("/analyze-audio", {
        method: "POST",
        body: form
    });

    const data = await res.json();
    document.getElementById("output").textContent = JSON.stringify(data, null, 2);

    lastSteps = [];
    if (data.instructions) {
        data.instructions.forEach(i => {
            lastSteps.push(...i.steps);
        });
    }
}

async function speakSteps() {
    if (lastSteps.length === 0) {
        alert("No steps to speak");
        return;
    }

    const res = await fetch("/speak-steps", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastSteps)
    });

    const blob = await res.blob();
    const audio = new Audio(URL.createObjectURL(blob));
    audio.play();
}
</script>

</body>
</html>
