<!DOCTYPE html>
<html>
<head>
  <title>Instruction Player</title>
  <style>
    body { font-family: Arial, sans-serif; }

    #controls button {
      margin: 4px;
      padding: 8px 12px;
      border: 1px solid #444;
      background: #f0f0f0;
      cursor: pointer;
    }

    #controls button.active {
      background: #444;
      color: #fff;
    }

    #sliderBox {
      position: relative;
      width: 500px;
      margin-top: 10px;
    }

    #slider { width: 500px; }

    .marker {
      position: absolute;
      top: -6px;
      width: 2px;
      height: 16px;
      background: red;
    }

    .instruction {
      display: flex;
      align-items: center;
      margin: 6px 0;
    }

    .speaker {
      cursor: pointer;
      font-size: 18px;
      margin-right: 8px;
    }

    .speaker:hover { color: green; }
  </style>
</head>
<body>

<h2>Instruction Audio Player</h2>

<button onclick="startRecording()">üéô Start Recording</button>
<button onclick="stopRecording()">‚èπ Stop Recording</button>

<br><br>

<input type="file" accept="audio/*" onchange="uploadFile(this.files[0])">

<hr>

<div id="controls">
  <button id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
  <button onclick="prev()">‚èÆ Back</button>
  <button onclick="next()">‚è≠ Forward</button>
  <button id="repeatBtn" onclick="toggleRepeat()">üîÅ Repeat One</button>
  <button id="loopBtn" onclick="toggleLoop()">üîÇ Loop All</button>
</div>

<div id="sliderBox">
  <input id="slider" type="range" min="0" step="0.01">
</div>

<h3>Instructions</h3>
<div id="instructionList"></div>

<pre id="output"></pre>

<script>
/* ================= AUDIO OBJECTS ================= */

const mainAudio = new Audio()     // top bar playback
const previewAudio = new Audio()  // speaker-only playback

/* ================= STATE ================= */

let timeline = []
let index = 0
let totalDuration = 0

let isPlaying = false
let repeatOne = false
let loopAll = false

/* ================= ELEMENTS ================= */

const slider = document.getElementById("slider")
const sliderBox = document.getElementById("sliderBox")
const instructionList = document.getElementById("instructionList")
const output = document.getElementById("output")

const playBtn = document.getElementById("playBtn")
const repeatBtn = document.getElementById("repeatBtn")
const loopBtn = document.getElementById("loopBtn")

/* ================= RECORD / UPLOAD ================= */

let recorder, chunks=[]

async function startRecording() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
  recorder = new MediaRecorder(stream)
  chunks=[]
  recorder.ondataavailable=e=>chunks.push(e.data)
  recorder.onstop=()=>{
    const f=new File([new Blob(chunks)],"recording.wav",{type:"audio/wav"})
    sendAudioFile(f)
  }
  recorder.start()
}

function stopRecording(){
  if(recorder && recorder.state!=="inactive") recorder.stop()
}

function uploadFile(file){
  if(file) sendAudioFile(file)
}

async function sendAudioFile(file){
  const fd=new FormData()
  fd.append("file",file)

  output.textContent="Processing..."

  const res=await fetch("/analyze-audio",{method:"POST",body:fd})
  const data=await res.json()

  output.textContent=JSON.stringify(data,null,2)

  timeline=data.timeline||[]
  totalDuration=timeline.length?timeline[timeline.length-1].end:0

  slider.max=totalDuration
  drawMarkers()
  renderInstructionList()

  resetPlayback()
}

/* ================= INSTRUCTION LIST ================= */

function renderInstructionList(){
  instructionList.innerHTML=""
  timeline.forEach((t,i)=>{
    const row=document.createElement("div")
    row.className="instruction"

    const sp=document.createElement("span")
    sp.className="speaker"
    sp.textContent="üîä"
    sp.onclick=()=>playPreview(i)

    const txt=document.createElement("span")
    txt.textContent=t.instruction

    row.appendChild(sp)
    row.appendChild(txt)
    instructionList.appendChild(row)
  })
}

function playPreview(i){
  previewAudio.pause()
  previewAudio.src=timeline[i].audio
  previewAudio.currentTime=0
  previewAudio.play()
}

/* ================= MAIN PLAYBACK ================= */

function resetPlayback(){
  index=0
  isPlaying=false
  mainAudio.pause()
  if(timeline.length>0){
    load(index)
  }
  updateButtons()
}

function load(i){
  index=i
  mainAudio.src=timeline[i].audio
  mainAudio.load()
}

function togglePlay(){
  if(!mainAudio.src) return
  if(isPlaying){
    mainAudio.pause()
    isPlaying=false
  } else {
    mainAudio.play()
    isPlaying=true
  }
  updateButtons()
}

function next(){
  if(index<timeline.length-1){
    load(index+1)
    mainAudio.play()
    isPlaying=true
  }
  updateButtons()
}

function prev(){
  if(index>0){
    load(index-1)
    mainAudio.play()
    isPlaying=true
  }
  updateButtons()
}

/* ================= TOGGLES ================= */

function toggleRepeat(){
  repeatOne=!repeatOne
  updateButtons()
}

function toggleLoop(){
  loopAll=!loopAll
  updateButtons()
}

/* ================= EVENTS ================= */

mainAudio.ontimeupdate=()=>{
  slider.value=timeline[index].start+mainAudio.currentTime
}

mainAudio.onended=()=>{
  if(repeatOne){
    mainAudio.currentTime=0
    mainAudio.play()
    return
  }

  if(index<timeline.length-1){
    load(index+1)
    mainAudio.play()
    return
  }

  if(loopAll){
    load(0)
    mainAudio.play()
    return
  }

  isPlaying=false
  updateButtons()
}

/* ================= SLIDER ================= */

slider.oninput=e=>{
  const t=+e.target.value
  const i=timeline.findIndex(x=>t>=x.start&&t<x.end)
  if(i!==-1){
    load(i)
    mainAudio.currentTime=t-timeline[i].start
    mainAudio.play()
    isPlaying=true
    updateButtons()
  }
}

/* ================= UI ================= */

function updateButtons(){
  playBtn.classList.toggle("active",isPlaying)
  repeatBtn.classList.toggle("active",repeatOne)
  loopBtn.classList.toggle("active",loopAll)
  playBtn.textContent=isPlaying?"‚è∏ Pause":"‚ñ∂ Play"
}

/* ================= MARKERS ================= */

function drawMarkers(){
  sliderBox.querySelectorAll(".marker").forEach(m=>m.remove())
  timeline.forEach(t=>{
    const m=document.createElement("div")
    m.className="marker"
    m.style.left=(t.start/totalDuration)*100+"%"
    sliderBox.appendChild(m)
  })
}
</script>

</body>
</html>
